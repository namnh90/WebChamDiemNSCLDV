<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bảng điểm chung cuộc</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --green-dark: #006837;
            --green-light: #00a86b;
        }

        html {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", sans-serif;
            background: url("photo/backgroundbig.png") no-repeat center center/cover fixed;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            color: #fff;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            z-index: -1;
        }

        .navbar {
            height: 110px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: relative;
            z-index: 2;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }

        .nav-side {
            width: 250px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        #homepage-link {
            background-color: rgba(59, 130, 246, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        #homepage-link:hover {
            background-color: rgba(37, 99, 235, 1);
        }

        .navbar-title {
            font-family: 'Saira Stencil One', sans-serif;
            font-size: clamp(12px, 6.5vw, 40px);
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
            flex-grow: 1;
            text-wrap: balance;
            background: linear-gradient(360deg, #ffffff 20%, #f50101 100%);
            -webkit-background-clip: text;
            background-clip: text;
            text-transform: uppercase;
            color: transparent;
            text-shadow:
                0px 1px 1px rgb(24, 129, 47),
                0px -0px 0px rgba(255, 255, 255),
                3px 3px 5px rgb(255, 255, 255);
        }

        .nav-side.logo {
            justify-content: flex-end;
        }

        .nav-side.logo img {
            height: 80px;
            object-fit: contain;
        }

        main {
            flex: 1;
            position: relative;
            z-index: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .admin-panel {
            width: 100%;
            max-width: none;
            box-sizing: border-box;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-responsive-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        footer {
            text-align: center;
            padding: 14px;
            font-size: 14px;
            color: #eee;
            background: rgba(0, 0, 0, 0.65);
            position: relative;
            z-index: 2;
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .filter-btn.active {
            background-color: var(--green-dark);
            color: white;
            border-color: var(--green-light);
            box-shadow: 0 4px 15px rgba(0, 104, 55, .3);
        }

        .leaderboard-wrapper {
            overflow-x: auto;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(3px);
            background: rgba(32, 64, 50, 0.85);
            padding: 6px;
        }

        .leaderboard {
            width: 100%;
            border-collapse: collapse;
            color: #fff;
            font-size: 15px;
            text-align: center;
            min-width: 800px;
        }
        
        .leaderboard.detailed {
           min-width: 1200px;
        }

        .leaderboard thead th {
            background: linear-gradient(90deg, #009f6b, #007f52);
            font-weight: 700;
            padding: 12px;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: normal;
            vertical-align: middle;
        }
        
        .leaderboard.detailed thead .group-header {
            background: #007f52;
        }

        .leaderboard.detailed thead .sub-header {
            font-size: 0.9em;
            font-weight: 600;
            padding: 8px;
        }
        
        .leaderboard.detailed .judge-divider {
            border-right: 2px solid rgba(255, 255, 255, 0.2);
        }

        .leaderboard tbody tr {
            background: rgba(255, 255, 255, 0.12);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.25s ease;
        }

        .leaderboard tbody tr:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.01);
        }

        .leaderboard td {
            padding: 10px 12px;
            vertical-align: middle;
            white-space: normal;
            word-break: break-word;
        }

        .leaderboard tr.gold {
            background: linear-gradient(90deg, #ffd70055, #ffcc0066);
            font-weight: bold;
        }

        .leaderboard tr.silver {
            background: linear-gradient(90deg, #c0c0c055, #e0e0e066);
        }

        .leaderboard tr.bronze {
            background: linear-gradient(90deg, #cd7f3255, #d79f4f66);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            min-width: 250px;
        }

        .user-cell .avatar {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #00ff99;
            box-shadow: 0 0 10px rgba(0, 255, 150, 0.4);
            flex-shrink: 0;
        }

        .user-cell .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .user-cell .avatar img:hover {
            transform: scale(1.1);
        }

        .user-cell .info {
            display: flex;
            flex-direction: column;
        }

        .user-cell .name {
            font-weight: 600;
            font-size: 15px;
            color: #fff;
        }

        .user-cell .code {
            font-size: 13px;
            opacity: 0.8;
            color: #e0e0e0;
        }

        .admin-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .export-btn {
            background: linear-gradient(90deg, #007a3d, #00b26b);
            border: none;
            color: #fff;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .export-btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(90deg, #00b26b, #009157);
        }

        @media (max-width: 992px) {
            .navbar-title {
                font-size: clamp(24px, 4vw, 36px);
            }
        }

        @media (max-width: 768px) {
            .navbar {
                height: 80px;
                justify-content: center;
            }

            .nav-side {
                display: none;
            }
            .leaderboard.detailed .judge-divider {
                border: none;
            }
            .user-cell .name { font-size: 14px; }
            .user-cell .code { font-size: 12px; }
            .leaderboard td, .leaderboard th { padding: 8px; }
            .leaderboard thead { display: none; }
            .leaderboard tbody tr {
                display: flex;
                flex-direction: column;
                margin-bottom: 18px;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 12px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
                padding: 12px;
                text-align: left;
            }
            .leaderboard tbody tr td {
                display: flex;
                align-items: center;
                gap: 15px;
                border: none;
                padding: 8px 0;
            }
            .leaderboard tbody tr td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #a0ffda;
                flex-shrink: 0;
                width: 110px;
            }
            .leaderboard tbody tr td>span {
                flex-grow: 1;
                text-align: right;
            }
            .leaderboard td.user-cell {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 12px;
                min-width: unset;
            }
            .leaderboard td b { font-size: 18px; color: #fff; }
            .leaderboard, .leaderboard.detailed { min-width: 0; }
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="nav-side">
            <a id="homepage-link" href="homepage.html" style="display: none;">Về Trang chủ</a>
        </div>
        <h1 class="navbar-title">Bảng Điểm Tổng Hợp</h1>
        <div class="nav-side logo">
            <img src="photo/logo.png" alt="Logo">
        </div>
    </div>
    <main>
        <div class="admin-panel">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="overall">Chung cuộc</button>
                <button class="filter-btn" data-filter="detailed">Điểm từng phần</button>
            </div>
            <div class="admin-actions">
                <button id="exportBtn" class="export-btn" onclick="exportToExcel()">⬇️ Xuất Excel</button>
            </div>
            <div class="table-responsive-wrapper" id="admin-table-container">
                <p style="text-align:center; padding: 50px;">Đang tải dữ liệu thống kê...</p>
            </div>
        </div>
    </main>
    <footer>
        © 2025 - WEB CHẤM ĐIỂM CUỘC THI NGÔI SAO CHẤT LƯỢNG DỊCH VỤ - Phát triển bởi Phòng Quản lý chất lượng
    </footer>

    <script>
        const MASTER_FLOW_URL = "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/664bb920ad5f4b6ebf79de6bfd08cd7e/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Hpz2vM23kQzxECy0RqGx94qFOJBPDRBIxdgeCqPnAvI";
        const ADMIN_USERS = ['ADMIN'];
        
        const JUDGES = [
            { id: 'BGK1', name: 'Điểm Giám khảo 1', short: 'Đ.GK 1' },
            { id: 'BGK2', name: 'Điểm Giám khảo 2', short: 'Đ.GK 2' },
            { id: 'BGK3', name: 'Điểm Giám khảo 3', short: 'Đ.GK 3' },
            { id: 'BGK4', name: 'Điểm Giám khảo 4', short: 'Đ.GK 4' }
        ];

        // ✅ BƯỚC 1: Thêm dữ liệu mapping STT và Mã CB bạn đã cung cấp
        const contestantSttData = [
            {"STT":1, "Mã CB":52244},
            {"STT":2, "Mã CB":49065},
            {"STT":3, "Mã CB":42401},
            {"STT":4, "Mã CB":37092},
            {"STT":5, "Mã CB":38356},
            {"STT":6, "Mã CB":33173},
            {"STT":7, "Mã CB":54503},
            {"STT":8, "Mã CB":54897},
            {"STT":9, "Mã CB":47649},
            {"STT":10, "Mã CB":38492}
        ];

        // Tạo một Map để tra cứu STT từ Mã CB một cách nhanh chóng
        const macbToSttMap = new Map(contestantSttData.map(item => [String(item["Mã CB"]), item.STT]));

        let processedContestantData = [];

        document.addEventListener('DOMContentLoaded', function () {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (!loggedInUser || !ADMIN_USERS.includes(loggedInUser)) {
                alert("⚠️ Bạn không có quyền truy cập trang này!");
                window.location.href = 'login.html';
                return;
            }
            checkAdminStatus(loggedInUser);
            fetchAllAdminData();
            
            document.querySelector('.filter-buttons').addEventListener('click', (e) => {
                if (e.target.matches('.filter-btn')) {
                    const filter = e.target.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderTable(processedContestantData, filter);
                }
            });
        });

        function checkAdminStatus(loggedInUser) {
            const homepageLink = document.getElementById('homepage-link');
            if (homepageLink && ADMIN_USERS.includes(loggedInUser)) {
                homepageLink.style.display = 'inline-block';
            }
        }

        async function fetchAllAdminData() {
            try {
                const [contestants, allScores] = await Promise.all([
                    fetchContestants(),
                    fetchAllScores()
                ]);
                processedContestantData = processData(contestants, allScores);
                renderTable(processedContestantData, 'overall');
            } catch (error) {
                console.error("LỖI NGHIÊM TRỌNG khi tải dữ liệu:", error);
                document.getElementById('admin-table-container').innerHTML = `<p style="color: #ffdddd; text-align: center;">Lỗi tải dữ liệu: ${error.message}</p>`;
            }
        }

        function processData(contestants, allScores) {
            const dataMap = new Map();
            contestants.forEach(p => {
                const macb = p["Mã CB"];
                if (macb) {
                    const macbStr = String(macb).trim();
                    // ✅ BƯỚC 2: Thêm STT vào dữ liệu của mỗi thí sinh
                    const stt = macbToSttMap.get(macbStr);

                    dataMap.set(macbStr, {
                        ...p,
                        STT: stt, // Gán STT vào đây
                        scoresByJudge: {},
                        finalScore: 0,
                        part1Score: 0,
                        part2Score: 0
                    });
                }
            });

            allScores.forEach(score => {
                try {
                    const ref = (score.REF || "").trim();
                    if (ref.length < 6) return;
                    const judge = ref.substring(0, 4);
                    const part = ref.slice(-1);
                    const macb = ref.substring(4, ref.length - 1);
                    const jsonData = JSON.parse(score.JSONDATA || "{}");
                    const total = parseInt(jsonData?.scores?.total, 10) || 0;
                    if (!macb || !dataMap.has(macb)) return;
                    
                    const contestant = dataMap.get(macb);
                    if (!contestant.scoresByJudge[judge]) contestant.scoresByJudge[judge] = {};
                    contestant.scoresByJudge[judge][`part${part}`] = total;
                } catch (e) { /* ignore parse errors */ }
            });

            dataMap.forEach(contestant => {
                let weightedTotalSum = 0, judgeCount = 0;
                let part1Total = 0, part1Count = 0;
                let part2Total = 0, part2Count = 0;

                Object.values(contestant.scoresByJudge).forEach(judgeScores => {
                    const part1 = judgeScores.part1 || 0;
                    const part2 = judgeScores.part2 || 0;
                    
                    if (part1 > 0) {
                        part1Total += part1;
                        part1Count++;
                    }
                    if (part2 > 0) {
                        part2Total += part2;
                        part2Count++;
                    }

                    if (part1 > 0 || part2 > 0) {
                        weightedTotalSum += (part1 * 0.5) + (part2 * 0.5);
                        judgeCount++;
                    }
                });

                contestant.finalScore = judgeCount ? (weightedTotalSum / judgeCount).toFixed(2) : 0;
                contestant.part1Score = part1Count ? (part1Total / part1Count).toFixed(2) : 0;
                contestant.part2Score = part2Count ? (part2Total / part2Count).toFixed(2) : 0;
            });
            
            return Array.from(dataMap.values());
        }

        function renderTable(data, filter = 'overall') {
            const container = document.getElementById('admin-table-container');
            data.sort((a, b) => (parseFloat(b.finalScore) || 0) - (parseFloat(a.finalScore) || 0));

            // Không cần mảng images cũ nữa

            let html;
            
            if(filter === 'detailed') {
                html = renderDetailedTable(data);
            } else {
                html = renderOverallTable(data);
            }

            container.innerHTML = html;
        }
        
        // Không cần hàm getStableImage nữa
        
        function renderOverallTable(data){
            let tableHtml = `
            <div class="leaderboard-wrapper">
              <table class="leaderboard">
                <thead>
                  <tr>
                    <th>🏆 Hạng</th>
                    <th>Thí sinh</th>
                    <th>Đơn vị</th>
                    ${JUDGES.map(j => `<th title="${j.name}">${j.short}</th>`).join('')}
                    <th>Điểm TB</th>
                  </tr>
                </thead>
                <tbody>`;

            data.forEach((p, i) => {
                const rank = i + 1;
                // ✅ BƯỚC 3: Dựng đường dẫn ảnh trực tiếp từ STT
                const img = p.STT ? `photo/user${p.STT}.jpg` : 'photo/default-avatar.png';
                const highlightClass = rank === 1 ? "gold" : rank === 2 ? "silver" : rank === 3 ? "bronze" : "";

                tableHtml += `
                <tr class="${highlightClass}">
                  <td data-label="Hạng"><span><b>#${rank}</b></span></td>
                  <td data-label="Thí sinh" class="user-cell">
                    <div class="avatar"><img src="${img}" onerror="this.src='photo/default-avatar.png'"></div>
                    <div class="info"><div class="name">${p["Họ tên"]}</div><div class="code">Mã CB: ${p["Mã CB"]}</div></div>
                  </td>
                  <td data-label="Đơn vị"><span>${p["Tên CN"] || ""}</span></td>
                  ${JUDGES.map(j => {
                      const s = p.scoresByJudge[j.id];
                      let scoreToShow = s ? ((s.part1 || 0) * 0.5) + ((s.part2 || 0) * 0.5) : "-";
                      if(typeof scoreToShow === 'number') scoreToShow = scoreToShow.toFixed(2);
                      if(scoreToShow === "0.00") scoreToShow = "-";
                      return `<td data-label="${j.name}"><span>${scoreToShow}</span></td>`;
                  }).join('')}
                  <td data-label="Điểm TB"><span><b>${p.finalScore || 0}</b></span></td>
                </tr>`;
            });

            tableHtml += `</tbody></table></div>`;
            return tableHtml;
        }
        
        function renderDetailedTable(data){
             let tableHtml = `
            <div class="leaderboard-wrapper">
              <table class="leaderboard detailed">
                <thead>
                  <tr>
                    <th rowspan="2">🏆 Hạng</th>
                    <th rowspan="2">Thí sinh</th>
                    <th rowspan="2">Đơn vị</th>
                    ${JUDGES.map(j => `<th class="group-header" colspan="2">${j.name}</th>`).join('')}
                  </tr>
                  <tr>
                    ${JUDGES.map(() => `<th class="sub-header">P.1</th><th class="sub-header judge-divider">P.2</th>`).join('')}
                  </tr>
                </thead>
                <tbody>`;

            data.forEach((p, i) => {
                const rank = i + 1;
                // ✅ BƯỚC 3 (tương tự): Dựng đường dẫn ảnh trực tiếp từ STT
                const img = p.STT ? `photo/user${p.STT}.jpg` : 'photo/default-avatar.png';
                const highlightClass = rank === 1 ? "gold" : rank === 2 ? "silver" : rank === 3 ? "bronze" : "";

                tableHtml += `
                <tr class="${highlightClass}">
                  <td data-label="Hạng"><span><b>#${rank}</b></span></td>
                  <td data-label="Thí sinh" class="user-cell">
                    <div class="avatar"><img src="${img}" onerror="this.src='photo/default-avatar.png'"></div>
                    <div class="info"><div class="name">${p["Họ tên"]}</div><div class="code">Mã CB: ${p["Mã CB"]}</div></div>
                  </td>
                  <td data-label="Đơn vị"><span>${p["Tên CN"] || ""}</span></td>
                  ${JUDGES.map(j => {
                      const s = p.scoresByJudge[j.id];
                      const p1 = s?.part1 ?? '-';
                      const p2 = s?.part2 ?? '-';
                      return `<td data-label="${j.short} P.1"><span>${p1}</span></td><td data-label="${j.short} P.2" class="judge-divider"><span>${p2}</span></td>`;
                  }).join('')}
                </tr>`;
            });

            tableHtml += `</tbody></table></div>`;
            return tableHtml;
        }

        async function fetchContestants(){const payload={action:"get_contestants"};const response=await fetch(MASTER_FLOW_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!response.ok)throw new Error('Không thể tải danh sách thí sinh');return await response.json()}async function fetchAllScores(){const payload={action:"get_all_scores"};const response=await fetch(MASTER_FLOW_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!response.ok)throw new Error('Không thể tải danh sách điểm');return await response.json()}async function exportToExcel(){const btn=document.getElementById("exportBtn");btn.disabled=true;btn.textContent="⏳ Đang xuất Excel...";try{const payload={action:"get_all_scores"};const res=await fetch(MASTER_FLOW_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!res.ok)throw new Error("Không thể tải dữ liệu JSON từ Flow");const json=await res.json();if(!Array.isArray(json)||json.length===0){alert("⚠️ Không có dữ liệu để xuất Excel!");return}const allCriteria=new Set;json.forEach(item=>{try{const data=JSON.parse(item.JSONDATA||"{}");const details=data?.scores?.details||[];details.forEach(d=>allCriteria.add(d.criterion))}catch(e){}});const flattened=json.map(item=>{let parsed={};try{parsed=JSON.parse(item.JSONDATA||"{}")}catch{parsed={}}const details=parsed.scores?.details||[];const scoreMap={};details.forEach(d=>{scoreMap[d.criterion]=d.score});const row={REF:item.REF||"",BGKCHAM:item.BGKCHAM||parsed.judge||"",MACB:item.MACB||"",TENCB:item.TENCB||item.TenCB||"",CHINHANH:item.CHINHANH||"",PART:parsed.part||"",TOTAL:parsed.scores?.total||"",COMMENT:parsed.scores?.comment||"",SUBMISSION_TIME:parsed.submissionTimestamp||""};allCriteria.forEach(c=>{row[c]=scoreMap[c]||""});return row});const criteriaCols=Array.from(allCriteria);const baseCols=["REF","BGKCHAM","MACB","TENCB","CHINHANH","PART","TOTAL","COMMENT","SUBMISSION_TIME"];const finalCols=[...baseCols,...criteriaCols];const worksheet=XLSX.utils.json_to_sheet(flattened,{header:finalCols});const workbook=XLSX.utils.book_new();XLSX.utils.book_append_sheet(workbook,worksheet,"BangDiemChiTiet");const colWidths=finalCols.map(k=>({wch:Math.max(20,k.length+2)}));worksheet["!cols"]=colWidths;const excelBuffer=XLSX.write(workbook,{bookType:"xlsx",type:"array"});const blob=new Blob([excelBuffer],{type:"application/octet-stream"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="Bang_Diem_Chi_Tiet.xlsx";a.click();URL.revokeObjectURL(url);alert("✅ Xuất Excel thành công (đã bóc toàn bộ tiêu chí)!")}catch(err){console.error("❌ Lỗi export Excel:",err);alert("⚠️ Lỗi khi xuất Excel. Kiểm tra console để biết chi tiết.")}finally{btn.disabled=false;btn.textContent="⬇️ Xuất Excel"}}
    </script>
</body>

</html>